# XBK 校本课“年级”字段全链路实施方案

根据您的最新指示，方案已升级为全模块覆盖（课程、学生、选课），并在导入环节支持年级选择。

## 1. 后端修改 (Backend)

### 1.1 数据库模型变更
在 `backend/app/models/xbk/` 下的三个模型中添加 `grade` 字段：
- **`XbkCourse` (课程)**: 添加 `grade` (String, nullable)。
- **`XbkStudent` (学生)**: 添加 `grade` (String, nullable)。
- **`XbkSelection` (选课)**: 添加 `grade` (String, nullable)。
  - *理由*：虽然可以通过关联学生表查询，但在选课记录中冗余存储年级可提高查询性能，并确保历史数据的快照性质（即使学生后续升学，当年的选课记录仍保留当时的年级）。

### 1.2 API 与业务逻辑更新
- **Schema**: 更新 `XbkStudentOut/Upsert`, `XbkCourseOut/Upsert`, `XbkSelectionOut/Upsert`，增加 `grade` 字段。
- **导入接口 (`/import`)**:
  - 增加 `grade` 作为可选 Query 参数。
  - 逻辑升级：优先读取 Excel 中的“年级”列；若无，则使用 Query 参数指定的年级；若都无，则为空。
  - 将年级写入上述三张表。
- **列表接口 (`/students`, `/courses`, `/selections`, `/course-results`)**:
  - 增加 `grade` 过滤参数。
  - 在返回结果中包含 `grade` 字段。
  - `list_selections` 和 `list_course_results` 需要确保能根据 `grade` 筛选。

### 1.3 数据库迁移
- 生成并应用新的 Alembic 迁移脚本。

## 2. 前端修改 (Frontend)

### 2.1 类型定义
- 更新 `XbkStudent`, `XbkCourse`, `XbkSelection` 及相关 API 参数接口，增加 `grade`。

### 2.2 界面改造 (`frontend/src/pages/Xbk/index.tsx`)
- **通用筛选栏**: 在“年份”、“学期”后增加“年级”下拉框（高一/高二/全部），作用于所有 Tab。
- **表格列 (Table Columns)**:
  - **课程列表**: 插入“年级”列。
  - **学生名单**: 插入“年级”列。
  - **选课结果**: 插入“年级”列。
- **导入模态框**:
  - 在选择文件之前或同时，增加“所属年级”下拉选择框（高一/高二）。
  - 上传时将该值作为参数传递给后端。

## 3. 执行步骤
1.  **后端开发**: 修改 Model -> Schema -> API Logic。
2.  **数据迁移**: 生成并执行 DB Migration。
3.  **前端开发**: 修改 UI 组件与 API 调用。
4.  **构建部署**:
    - 由于涉及前后端代码修改，将重新构建 Docker 镜像 (`backend`, `frontend`) 并重启服务，确保改动生效。
    - 验证各模块的筛选、显示及导入功能。
