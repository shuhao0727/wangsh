# ============================================
# 后端开发环境 Dockerfile
# 支持热重载和开发调试
# ============================================

# 基础镜像：Python 3.11（Slim 轻量版）
FROM python:3.11-slim AS development

# 设置工作目录
WORKDIR /app

# 构建环境：避免继承宿主机的代理配置导致 pip/apt 访问失败
ARG http_proxy
ARG https_proxy
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG all_proxy
ARG ALL_PROXY
ARG no_proxy
ARG NO_PROXY
ENV http_proxy=
ENV https_proxy=
ENV HTTP_PROXY=
ENV HTTPS_PROXY=
ENV all_proxy=
ENV ALL_PROXY=
ENV no_proxy=
ENV NO_PROXY=
ENV PIP_CONFIG_FILE=/dev/null
ARG PIP_INDEX_URL=https://pypi.org/simple
ENV PIP_INDEX_URL=${PIP_INDEX_URL}

# 设置环境变量
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

# 系统依赖：尽量保持最小化（项目依赖以 manylinux wheels 为主，避免 apt 依赖导致构建不稳定）

# 复制依赖文件
COPY requirements.txt .

# 安装 Python 依赖
RUN env -u http_proxy -u https_proxy -u HTTP_PROXY -u HTTPS_PROXY -u all_proxy -u ALL_PROXY \
    pip install --upgrade pip \
    && env -u http_proxy -u https_proxy -u HTTP_PROXY -u HTTPS_PROXY -u all_proxy -u ALL_PROXY \
    pip install -r requirements.txt

ARG TYPST_VERSION=0.14.2

RUN apt-get -o Acquire::http::Proxy=false -o Acquire::https::Proxy=false update \
    && apt-get -o Acquire::http::Proxy=false -o Acquire::https::Proxy=false install -y --no-install-recommends \
    ca-certificates curl xz-utils fontconfig \
    fonts-noto-cjk fonts-noto-core fonts-noto-extra \
    fonts-liberation fonts-dejavu-core \
    fonts-arphic-ukai fonts-arphic-uming \
    fonts-wqy-zenhei \
    && rm -rf /var/lib/apt/lists/* \
    && printf '%s\n' \
    '<?xml version="1.0"?>' \
    '<!DOCTYPE fontconfig SYSTEM "fonts.dtd">' \
    '<fontconfig>' \
    '  <alias>' \
    '    <family>Times New Roman</family>' \
    '    <prefer><family>Liberation Serif</family><family>Noto Serif</family></prefer>' \
    '  </alias>' \
    '  <alias>' \
    '    <family>STSong</family>' \
    '    <prefer><family>Noto Serif CJK SC</family><family>AR PL UMing CN</family></prefer>' \
    '  </alias>' \
    '  <alias>' \
    '    <family>Kaiti SC</family>' \
    '    <prefer><family>AR PL UKai CN</family><family>Noto Serif CJK SC</family></prefer>' \
    '  </alias>' \
    '  <alias>' \
    '    <family>STXihei</family>' \
    '    <prefer><family>Noto Sans CJK SC</family><family>WenQuanYi Zen Hei</family></prefer>' \
    '  </alias>' \
    '</fontconfig>' \
    > /etc/fonts/local.conf \
    && fc-cache -f \
    && ARCH="$(uname -m)" \
    && if [ "$ARCH" = "x86_64" ]; then PKG="typst-x86_64-unknown-linux-musl.tar.xz"; elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then PKG="typst-aarch64-unknown-linux-musl.tar.xz"; else echo "unsupported arch: $ARCH" && exit 1; fi \
    && curl --noproxy '*' -x '' -fsSL "https://github.com/typst/typst/releases/download/v${TYPST_VERSION}/${PKG}" -o /tmp/typst.tar.xz \
    && tar -xf /tmp/typst.tar.xz -C /tmp \
    && tar -tf /tmp/typst.tar.xz | head -n 1 | cut -d/ -f1 > /tmp/typst_dir \
    && TDIR="$(cat /tmp/typst_dir)" \
    && install -m 0755 "/tmp/${TDIR}/typst" /usr/local/bin/typst \
    && rm -rf /tmp/typst.tar.xz "/tmp/${TDIR}" /tmp/typst_dir

# 复制源代码
COPY . .

# 创建非 root 用户
RUN useradd -m -u 1000 appuser \
    && mkdir -p /app/data/typst_pdfs \
    && chown -R appuser:appuser /app
USER appuser

# 暴露端口
EXPOSE 8000

# 启动开发服务器（热重载）
CMD ["python", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]

# ============================================
# 生产构建阶段
# ============================================
FROM python:3.11-slim AS builder

WORKDIR /app

ARG http_proxy
ARG https_proxy
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG all_proxy
ARG ALL_PROXY
ARG no_proxy
ARG NO_PROXY
ENV http_proxy=
ENV https_proxy=
ENV HTTP_PROXY=
ENV HTTPS_PROXY=
ENV all_proxy=
ENV ALL_PROXY=
ENV no_proxy=
ENV NO_PROXY=
ENV PIP_CONFIG_FILE=/dev/null
ARG PIP_INDEX_URL=https://pypi.org/simple
ENV PIP_INDEX_URL=${PIP_INDEX_URL}

# 系统依赖：此项目数据库驱动使用 asyncpg，无需 libpq-dev

# 复制依赖文件
COPY requirements.txt .

# 安装依赖（生产环境）
RUN env -u http_proxy -u https_proxy -u HTTP_PROXY -u HTTPS_PROXY -u all_proxy -u ALL_PROXY \
    pip install --upgrade pip \
    && env -u http_proxy -u https_proxy -u HTTP_PROXY -u HTTPS_PROXY -u all_proxy -u ALL_PROXY \
    pip install -r requirements.txt

# 复制源代码
COPY . .

# ============================================
# 生产运行阶段
# ============================================
FROM python:3.11-slim AS production

WORKDIR /app

ARG http_proxy
ARG https_proxy
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG all_proxy
ARG ALL_PROXY
ARG no_proxy
ARG NO_PROXY
ENV http_proxy=
ENV https_proxy=
ENV HTTP_PROXY=
ENV HTTPS_PROXY=
ENV all_proxy=
ENV ALL_PROXY=
ENV no_proxy=
ENV NO_PROXY=

ARG TYPST_VERSION=0.14.2

RUN apt-get -o Acquire::http::Proxy=false -o Acquire::https::Proxy=false update \
    && apt-get -o Acquire::http::Proxy=false -o Acquire::https::Proxy=false install -y --no-install-recommends \
    ca-certificates curl xz-utils fontconfig \
    fonts-noto-cjk fonts-noto-core fonts-noto-extra \
    fonts-liberation fonts-dejavu-core \
    fonts-arphic-ukai fonts-arphic-uming \
    fonts-wqy-zenhei \
    && rm -rf /var/lib/apt/lists/* \
    && printf '%s\n' \
    '<?xml version="1.0"?>' \
    '<!DOCTYPE fontconfig SYSTEM "fonts.dtd">' \
    '<fontconfig>' \
    '  <alias>' \
    '    <family>Times New Roman</family>' \
    '    <prefer><family>Liberation Serif</family><family>Noto Serif</family></prefer>' \
    '  </alias>' \
    '  <alias>' \
    '    <family>STSong</family>' \
    '    <prefer><family>Noto Serif CJK SC</family><family>AR PL UMing CN</family></prefer>' \
    '  </alias>' \
    '  <alias>' \
    '    <family>Kaiti SC</family>' \
    '    <prefer><family>AR PL UKai CN</family><family>Noto Serif CJK SC</family></prefer>' \
    '  </alias>' \
    '  <alias>' \
    '    <family>STXihei</family>' \
    '    <prefer><family>Noto Sans CJK SC</family><family>WenQuanYi Zen Hei</family></prefer>' \
    '  </alias>' \
    '</fontconfig>' \
    > /etc/fonts/local.conf \
    && fc-cache -f \
    && ARCH="$(uname -m)" \
    && if [ "$ARCH" = "x86_64" ]; then PKG="typst-x86_64-unknown-linux-musl.tar.xz"; elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then PKG="typst-aarch64-unknown-linux-musl.tar.xz"; else echo "unsupported arch: $ARCH" && exit 1; fi \
    && curl --noproxy '*' -x '' -fsSL "https://github.com/typst/typst/releases/download/v${TYPST_VERSION}/${PKG}" -o /tmp/typst.tar.xz \
    && tar -xf /tmp/typst.tar.xz -C /tmp \
    && tar -tf /tmp/typst.tar.xz | head -n 1 | cut -d/ -f1 > /tmp/typst_dir \
    && TDIR="$(cat /tmp/typst_dir)" \
    && install -m 0755 "/tmp/${TDIR}/typst" /usr/local/bin/typst \
    && rm -rf /tmp/typst.tar.xz "/tmp/${TDIR}" /tmp/typst_dir

# 运行时依赖：此项目数据库驱动使用 asyncpg，无需 libpq5

# 从构建阶段复制已安装的包
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# 复制应用代码
COPY --from=builder /app /app

# 创建非 root 用户
RUN useradd -m -u 1000 appuser \
    && mkdir -p /app/data/typst_pdfs \
    && chown -R appuser:appuser /app
USER appuser

# 暴露端口
EXPOSE 8000

# 启动生产服务器
CMD ["sh", "-c", "python -m uvicorn main:app --host 0.0.0.0 --port 8000 --workers ${UVICORN_WORKERS:-4}"]
