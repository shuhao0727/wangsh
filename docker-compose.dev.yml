# ============================================
# 开发环境 Docker Compose 配置文件
# 热加载模式，支持快速开发迭代
# ============================================

services:
  # PostgreSQL 数据库服务
  postgres:
    image: public.ecr.aws/docker/library/postgres:16-alpine
    container_name: wangsh-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_MAX_CONNECTIONS: ${POSTGRES_MAX_CONNECTIONS}
      POSTGRES_STATEMENT_TIMEOUT: ${POSTGRES_STATEMENT_TIMEOUT}
      TZ: Asia/Shanghai
      PGTZ: Asia/Shanghai
    command: [ "postgres", "-c", "timezone=Asia/Shanghai" ]
    volumes:
      # 数据持久化到本地 data 目录
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - wangsh-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 服务（用于缓存和 Celery 代理）
  redis:
    image: public.ecr.aws/docker/library/redis:7-alpine
    container_name: wangsh-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    command: redis-server --appendonly yes
    networks:
      - wangsh-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  adminer:
    image: adminer:4.8.1
    container_name: wangsh-adminer
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      ADMINER_DESIGN: "pappu687"
    networks:
      - wangsh-network
    depends_on:
      - postgres

  # 后端服务 (Python FastAPI)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
      target: development
    container_name: wangsh-backend
    restart: unless-stopped
    environment:
      # 设置部署环境为docker，配置类将自动调整主机地址
      - DEPLOYMENT_ENV=docker
      - DOCKER_POSTGRES_HOST=postgres
      - DOCKER_REDIS_HOST=redis
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - SUPER_ADMIN_USERNAME=${SUPER_ADMIN_USERNAME}
      - SUPER_ADMIN_PASSWORD=${SUPER_ADMIN_PASSWORD}
      # 其他必要环境变量
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=True
      - LOG_LEVEL=INFO
      - TZ=Asia/Shanghai
      - APP_VERSION=${APP_VERSION}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - UPLOAD_FOLDER=./uploads
      - TYPST_PDF_STORAGE_DIR=/app/data/typst_pdfs
      - MAX_UPLOAD_SIZE=10485760
      # 开发模式热加载
      - BACKEND_RELOAD=True
      - PYTHONLAB_DEFAULT_MEMORY_MB=128
    volumes:
      # 代码热重载：将本地代码挂载到容器
      - ./backend:/app
      # 上传文件持久化 - 使用容器内的绝对路径
      - ./data/uploads:/app/uploads
      # Typst PDF 存储目录（与 worker 共享）
      - ./data/typst_pdfs:/app/data/typst_pdfs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - wangsh-network
      - dify_network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: >
      sh -c "python -m uvicorn main:app --host 0.0.0.0 --port 8000 --reload"
    healthcheck:
      test: [ "CMD-SHELL", "curl -fsS http://localhost:8000/health >/dev/null || exit 1" ]
      interval: 10s
      timeout: 3s
      retries: 10

  # Celery Worker 服务（Typst 异步任务处理）
  typst-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: wangsh-typst-worker
    restart: unless-stopped
    environment:
      # 设置部署环境为docker，配置类将自动调整主机地址
      - DEPLOYMENT_ENV=docker
      - DOCKER_POSTGRES_HOST=postgres
      - DOCKER_REDIS_HOST=redis
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=True
      - LOG_LEVEL=INFO
      - TZ=Asia/Shanghai
      - APP_VERSION=${APP_VERSION}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Celery 特定配置
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - TYPST_COMPILE_MAX_CONCURRENCY=${TYPST_COMPILE_MAX_CONCURRENCY:-2}
      - TYPST_COMPILE_USE_CELERY=true
      - TYPST_PDF_STORAGE_DIR=/app/data/typst_pdfs
      - TYPST_STORE_PDF_IN_DB=false
    volumes:
      - ./backend:/app
      - ./data/typst_pdfs:/app/data/typst_pdfs
    depends_on:
      - redis
      - backend
    networks:
      - wangsh-network
    command: >
      sh -c "sleep 10 && celery -A app.celery_app:celery worker -l INFO -Q typst -c ${TYPST_WORKER_CONCURRENCY:-1}"

  # PythonLab Worker 服务（代码执行沙箱任务）
  pythonlab-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: wangsh-pythonlab-worker
    restart: unless-stopped
    user: "0:0" # 需要 root 权限操作 docker socket
    environment:
      - DEPLOYMENT_ENV=docker
      - DOCKER_POSTGRES_HOST=postgres
      - DOCKER_REDIS_HOST=redis
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=True
      - LOG_LEVEL=INFO
      - TZ=Asia/Shanghai
      - APP_VERSION=${APP_VERSION}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # PythonLab 调试会话相关
      - PYTHONLAB_SANDBOX_IMAGE=${PYTHONLAB_SANDBOX_IMAGE:-shuhao07/pythonlab-sandbox:py311}
      - PYTHONLAB_WORKSPACE_ROOT=/tmp/pythonlab/workspaces
      - PYTHONLAB_SESSION_TTL_SECONDS=${PYTHONLAB_SESSION_TTL_SECONDS:-3600}
      - PYTHONLAB_UNATTACHED_TTL_SECONDS=${PYTHONLAB_UNATTACHED_TTL_SECONDS:-600}
      - PYTHONLAB_MAX_SESSIONS_PER_USER=${PYTHONLAB_MAX_SESSIONS_PER_USER:-5}
      - PYTHONLAB_DEBUGPY_PORT=${PYTHONLAB_DEBUGPY_PORT:-5678}
      - PYTHONLAB_ORPHAN_CLEANUP_ENABLED=${PYTHONLAB_ORPHAN_CLEANUP_ENABLED:-true}
      - PYTHONLAB_ORPHAN_CLEANUP_INTERVAL_SECONDS=${PYTHONLAB_ORPHAN_CLEANUP_INTERVAL_SECONDS:-300}
      - PYTHONLAB_HEARTBEAT_TIMEOUT_SECONDS=${PYTHONLAB_HEARTBEAT_TIMEOUT_SECONDS:-180}
      - PYTHONLAB_IDLE_TIMEOUT_SECONDS=${PYTHONLAB_IDLE_TIMEOUT_SECONDS:-3600}
      - HOST_WORKSPACE_ROOT=${PWD}/data/pythonlab/workspaces
      - PYTHONLAB_DEFAULT_MEMORY_MB=128
    volumes:
      - ./backend:/app
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data/pythonlab/workspaces:/tmp/pythonlab/workspaces
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535
    depends_on:
      - redis
      - backend
    networks:
      - wangsh-network
    command: >
      sh -c "sleep 10 && celery -A app.celery_app:celery worker -l INFO -Q celery -c ${PYTHONLAB_WORKER_CONCURRENCY:-1} --include app.tasks.pythonlab"

  # 前端服务 (React + TypeScript)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
      target: development
    restart: unless-stopped
    environment:
      - REACT_APP_API_URL=${REACT_APP_API_URL}
      - REACT_APP_ENV=${REACT_APP_ENV}
      - REACT_APP_VERSION=${REACT_APP_VERSION}
      # 开发模式热加载
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    volumes:
      # 代码热重载：将本地代码挂载到容器
      - ./frontend:/app
      - /app/node_modules # 避免覆盖容器内的 node_modules
    depends_on:
      - backend
    networks:
      - wangsh-network
    ports:
      - "${WEB_PORT:-6608}:6608"
    command: sh -c "npm start"



  # Caddy 服务 (反向代理)
  caddy:
    image: public.ecr.aws/docker/library/caddy:2-alpine
    container_name: wangsh-caddy
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-8080}:80"
    volumes:
      - ./gateway/Caddyfile.dev:/etc/caddy/Caddyfile
    depends_on:
      - frontend
      - backend
    networks:
      - wangsh-network
      - dify_network

# 网络配置
networks:
  wangsh-network:
    driver: bridge
  dify_network:
    external: true
    name: docker_default

# 数据卷配置
volumes:
  postgres_data:
  redis_data:
  uploads_data:
