# ============================================
# WangSh 项目环境变量配置模板
# 用法：
# 1) 复制本文件为 .env（开发/生产都用这一份作为模板）
# 2) 将 change_me 替换为真实值（不要提交 .env）
# 3) 环境变量说明见：docs/ENV.md
#
# 约定：
# - 不在 .env 中使用 ${VAR:-default} 这类 bash 展开语法
# - 注释请单独一行写（避免 KEY=VALUE # comment 形式）
# ============================================

# ==================== 项目信息 ====================
# 项目名称（主要用于展示/日志）
PROJECT_NAME=WangSh
# 项目版本号（可用于前后端展示）
VERSION=1.0.1
# API 前缀（后端路由统一前缀）
API_V1_STR=/api/v1

# ==================== 镜像发布（Docker Hub） ====================
# 镜像仓库（Docker Hub 固定 docker.io）
DOCKER_REGISTRY=docker.io
# 你的 Docker Hub 用户名或组织名（必须是你有权限的 namespace）
DOCKERHUB_NAMESPACE=shuhao07
# 镜像 tag：默认用 latest（你已经推送到 Docker Hub 了，服务器直接拉取即可）
# 如果你希望“固定版本部署”，把它改成 1.0.0 这类版本号
IMAGE_TAG=latest
# 同时推送 latest 时使用
IMAGE_TAG_LATEST=latest
# 镜像名称（不含 namespace）
IMAGE_NAME_BACKEND=wangsh-backend
IMAGE_NAME_FRONTEND=wangsh-frontend
IMAGE_NAME_WORKER=wangsh-typst-worker

# ==================== 部署环境 ====================
# development / docker / production
# 部署环境标识（影响数据库/Redis 主机自动判断等）
DEPLOYMENT_ENV=production

# ==================== 后端服务配置 ====================
# 后端监听地址（0.0.0.0 表示对外监听）
BACKEND_HOST=0.0.0.0
# 后端端口（FastAPI/uvicorn 对外端口）
BACKEND_PORT=8000
# 开发模式热重载（True/False）
BACKEND_RELOAD=True
# 后端调试模式（True/False；生产务必 False）
DEBUG=True
# 日志级别（INFO/DEBUG/WARNING/ERROR）
LOG_LEVEL=INFO

# ==================== 安全配置（必改） ====================
# 用于 JWT 签名等安全用途，生产必须为长随机串
# 密钥（必须修改；生产环境使用长随机字符串）
SECRET_KEY=change_me

# ==================== JWT 配置 ====================
# 访问令牌过期时间（分钟）
ACCESS_TOKEN_EXPIRE_MINUTES=11520
# 刷新令牌过期时间（天）
REFRESH_TOKEN_EXPIRE_DAYS=30
# JWT 签名算法（默认 HS256）
ALGORITHM=HS256

# ==================== 超级管理员（必改） ====================
# 超级管理员用户名（首次启动会创建/更新）
SUPER_ADMIN_USERNAME=admin
# 超级管理员密码（必须修改；首次启动会写入数据库）
SUPER_ADMIN_PASSWORD=change_me
# 超级管理员显示名（用于管理端展示）
SUPER_ADMIN_FULL_NAME=系统超级管理员

# 智能体密钥加密（必填）
# 用于加密存储 AI Provider API Key，必须是安全随机值（建议 32+ 字符）
AGENT_API_KEY_ENCRYPTION_KEY=change_me

# ==================== 前端服务配置 ====================
# FRONTEND_PORT 用于脚本/反向代理；PORT 是 React dev server 端口（建议相同）
# 前端服务端口（脚本展示/反向代理配置用）
FRONTEND_PORT=6608
# React dev server 端口（CRA 读取 PORT）
PORT=6608
# 生产部署对外 Web 端口（docker-compose.yml 里映射到 80）
WEB_PORT=6608
# 前端运行环境（development/production）
REACT_APP_ENV=production
# 前端请求后端 API 的基地址（开发一般直连后端 /api/v1）
REACT_APP_API_URL=/api/v1
# 前端版本（可用于 UI 展示）
REACT_APP_VERSION=1.0.1
# 前端热更新开关（脚本/配置使用，前端本身未必读取）
FRONTEND_HOT_RELOAD=True

# Caddy 镜像（前端生产镜像会使用它作为基础镜像）
CADDY_IMAGE=public.ecr.aws/docker/library/caddy:2.8.4

# Node 镜像（前端生产镜像构建使用）
NODE_IMAGE=node:20-alpine

# Python 镜像（后端/worker 构建基底；用非 DockerHub 源避免镜像加速器 502）
PYTHON_IMAGE=public.ecr.aws/docker/library/python:3.11-slim

# Python 包镜像（用于 docker build 时 pip install；默认用阿里云镜像提升稳定性）
PIP_INDEX_URL=https://mirrors.aliyun.com/pypi/simple

# ==================== CORS 配置 ====================
# 允许跨域来源列表（JSON 数组字符串）
CORS_ORIGINS=["http://localhost:6608","http://127.0.0.1:6608"]

# ==================== AI（可选：OpenRouter 默认配置） ====================
# 如果你不想把 key 存进数据库，可以在服务器用 env 提供默认 OpenRouter key
# OPENROUTER_API_URL=https://openrouter.ai/api/v1
# OPENROUTER_API_KEY=change_me

# ==================== 数据库（PostgreSQL） ====================
# 数据库用户名
POSTGRES_USER=admin
# 数据库密码（必须修改）
POSTGRES_PASSWORD=change_me
# 数据库名称
POSTGRES_DB=wangsh_db
# 数据库主机（本机开发一般 127.0.0.1；Docker 内一般 postgres）
POSTGRES_HOST=127.0.0.1
# 数据库端口
POSTGRES_PORT=5432
# 最大连接数（用于连接池配置）
POSTGRES_MAX_CONNECTIONS=100
# SQL 语句超时（毫秒）
POSTGRES_STATEMENT_TIMEOUT=30000
# SQLAlchemy 异步驱动（默认 asyncpg）
DATABASE_DRIVER=asyncpg

# 可选：如果你希望完全手写连接串，可显式设置
# DATABASE_URL=postgresql+asyncpg://admin:change_me@127.0.0.1:5432/wangsh_db

# ==================== Redis（缓存 / Celery） ====================
# Redis 主机（本机开发一般 127.0.0.1；Docker 内一般 redis）
REDIS_HOST=127.0.0.1
# Redis 端口
REDIS_PORT=6379
# Redis 容器名（用于脚本/自动检测）
REDIS_CONTAINER_NAME=wangsh-redis

# 可选：也可以显式给出 URL（否则后端会根据 host/port 组装）
# REDIS_URL=redis://127.0.0.1:6379/0
# REDIS_CACHE_URL=redis://127.0.0.1:6379/1

# ==================== Celery ====================
# 如果不使用 Celery，可以先保留默认值
# CELERY_BROKER_URL=redis://127.0.0.1:6379/0
# CELERY_RESULT_BACKEND=redis://127.0.0.1:6379/0
# Celery 任务序列化格式
CELERY_TASK_SERIALIZER=json
# Celery 结果序列化格式
CELERY_RESULT_SERIALIZER=json
# Celery 接受的内容类型（JSON 数组字符串）
CELERY_ACCEPT_CONTENT=["json"]

# ==================== 文件存储/数据目录 ====================
# 上传文件目录（相对后端工作目录）
UPLOAD_FOLDER=./uploads
# 单文件最大上传大小（字节）
MAX_UPLOAD_SIZE=10485760
# 数据目录（用于持久化/卷映射等）
DATA_DIR=./data

# ==================== 时区 ====================
# 时区（用于时间显示/日志/业务逻辑）
TIMEZONE=Asia/Shanghai

# ==================== SQLAlchemy 调试 ====================
# SQLAlchemy 是否打印 SQL（开发排查用）
SQLALCHEMY_ECHO=False
# SQLAlchemy 是否追踪修改（通常无需开启）
SQLALCHEMY_TRACK_MODIFICATIONS=False

# ==================== 向量数据库（预留，可选） ====================
# 向量数据库主机（预留）
VECTOR_DB_HOST=qdrant
# 向量数据库端口（预留）
VECTOR_DB_PORT=6333
# VECTOR_DB_URL=http://qdrant:6333

# ==================== 外部链接（非密钥，可按需） ====================
# Dify/NAS 为可选跳转链接；不配置则前端不展示入口
DIFY_URL=http://wangsh.cn:6606
NAS_URL=http://wangsh.cn:5000
REACT_APP_DIFY_URL=http://wangsh.cn:6606
REACT_APP_NAS_URL=http://wangsh.cn:5000

# ==================== Group Discussion / 实时能力 ====================
# 是否启用 Redis pubsub（建议生产开启，减少 SSE 轮询查库）
GROUP_DISCUSSION_REDIS_ENABLED=true

# ==================== 文章/分类缓存与分页 ====================
# 管理端文章列表缓存 TTL（秒）
ARTICLE_CACHE_ADMIN_LIST_TTL=180
# 管理端文章详情缓存 TTL（秒）
ARTICLE_CACHE_ADMIN_DETAIL_TTL=300
# 用户端文章详情缓存 TTL（秒）
ARTICLE_CACHE_USER_DETAIL_TTL=600
# 公开文章列表缓存 TTL（秒）
ARTICLE_CACHE_PUBLIC_LIST_TTL=300
# 公开文章详情缓存 TTL（秒）
ARTICLE_CACHE_PUBLIC_DETAIL_TTL=600
# 默认缓存 TTL（秒）
ARTICLE_CACHE_DEFAULT_TTL=300
# 文章默认分页大小
ARTICLE_PAGE_SIZE_DEFAULT=20
# 文章最大分页大小
ARTICLE_PAGE_SIZE_MAX=100
# 分类默认分页大小
CATEGORY_PAGE_SIZE_DEFAULT=20
# 分类最大分页大小
CATEGORY_PAGE_SIZE_MAX=100
# 公开分类分页大小
CATEGORY_PUBLIC_PAGE_SIZE=50
# 热门分类显示数量
CATEGORY_POPULAR_LIMIT=10
# 搜索分类返回数量限制
CATEGORY_SEARCH_LIMIT=20

# ==================== Redis 连接优化 ====================
# Redis 连接超时（秒）
REDIS_CONNECT_TIMEOUT=5
# 学生会话 TTL（秒）
STUDENT_SESSION_TTL=7200
# Redis 缓存使用的 DB index（0/1/2...）
REDIS_DB_CACHE=0

# ==================== Docker / Caddy（可选） ====================
# 仅当你使用 docker-compose + caddy 时再配置
# Docker 内后端服务名（caddy 反代用）
BACKEND_SERVICE_HOST=backend
# Docker 内后端服务端口（caddy 反代用）
BACKEND_SERVICE_PORT=8000
# Docker 内前端服务名（caddy 反代用）
FRONTEND_SERVICE_HOST=frontend
# Docker 内前端服务端口（caddy 反代用）
FRONTEND_SERVICE_PORT=6608
# Caddy 对外 HTTP 端口
CADDY_HTTP_PORT=8080
# Caddy 对外 HTTPS 端口
CADDY_HTTPS_PORT=8443
# Caddy 静态文件根目录（容器内路径）
CADDY_STATIC_ROOT=/usr/share/caddy/html
# Caddy 访问日志路径（容器内路径）
CADDY_ACCESS_LOG_PATH=/data/access.log
# Postgres 容器名（脚本/管理用）
POSTGRES_CONTAINER_NAME=wangsh-postgres
# 后端容器名（脚本/管理用）
BACKEND_CONTAINER_NAME=wangsh-backend
# Celery worker 容器名（脚本/管理用）
CELERY_WORKER_CONTAINER_NAME=wangsh-celery-worker
# 前端容器名（脚本/管理用）
FRONTEND_CONTAINER_NAME=wangsh-frontend
# Caddy 容器名（脚本/管理用）
CADDY_CONTAINER_NAME=wangsh-caddy

# ==================== Typst Worker（生产 compose 使用） ====================
TYPST_COMPILE_MAX_CONCURRENCY=2
TYPST_COMPILE_USE_CELERY=true
TYPST_PDF_STORAGE_DIR=/app/data/typst_pdfs
TYPST_STORE_PDF_IN_DB=false
# Docker 网络名
DOCKER_NETWORK_NAME=wangsh-network
# 后端健康检查间隔
BACKEND_HEALTH_INTERVAL=10s

# ==================== PythonLab（Docker + debugpy） ====================
# PythonLab 沙箱镜像名（必须能被后端 docker run 拉取/运行）
PYTHONLAB_SANDBOX_IMAGE=shuhao07/pythonlab-sandbox:py311
# PythonLab 会话工作区根目录（宿主机路径；每个 session 会在其下创建独立目录并挂载进容器 /workspace）
PYTHONLAB_WORKSPACE_ROOT=/tmp/pythonlab/workspaces
# 已连接（ATTACHED）调试会话 TTL（秒），超过后会话可能被回收
PYTHONLAB_SESSION_TTL_SECONDS=3600
# 未连接（PENDING/READY）会话 TTL（秒），避免创建后长期不连接导致资源泄露
PYTHONLAB_UNATTACHED_TTL_SECONDS=600
# 单个用户允许的并发调试会话数上限（超过会返回 QUOTA_EXCEEDED）
PYTHONLAB_MAX_SESSIONS_PER_USER=5
# 容器内 debugpy adapter 监听端口（后端会把它映射到宿主机随机端口）
PYTHONLAB_DEBUGPY_PORT=5678
# 是否启用后台清理任务（清理孤儿容器、过期会话）
PYTHONLAB_ORPHAN_CLEANUP_ENABLED=true
# 后台清理任务触发间隔（秒；最小 30 秒）
PYTHONLAB_ORPHAN_CLEANUP_INTERVAL_SECONDS=300
# 心跳超时阈值（秒；用于判定部分会话是否失活并触发 stop）
PYTHONLAB_HEARTBEAT_TIMEOUT_SECONDS=180
# 闲置回收阈值（秒；适用于 ATTACHED/STOPPED 等“可能在断点停住”的会话，避免短时间思考就被回收）
PYTHONLAB_IDLE_TIMEOUT_SECONDS=3600
# 后端健康检查超时
BACKEND_HEALTH_TIMEOUT=2s
# 前端健康检查间隔
FRONTEND_HEALTH_INTERVAL=10s
# 前端健康检查超时
FRONTEND_HEALTH_TIMEOUT=3s
# 容器重启策略
SERVICE_RESTART_POLICY=unless-stopped

TYPST_COMPILE_USE_CELERY=true
TYPST_PDF_STORAGE_DIR=./data/typst_pdfs
TYPST_STORE_PDF_IN_DB=false
TYPST_PDF_RETENTION_DAYS=30
TYPST_METRICS_SAMPLE_SIZE=200
TYPST_ASSET_MAX_BYTES=5242880
TYPST_ASSET_ALLOWED_EXTS=png,jpg,jpeg,gif,webp,svg,pdf
TYPST_ASSET_UPLOAD_RATE_LIMIT_SECONDS=1
TYPST_WORKER_CONCURRENCY=1
GROUP_DISCUSSION_JOIN_LOCK_SECONDS=300

# ==================== Agent Chat Optimization（智能体并发优化） ====================
# HTTPX Client Limits
# HTTPX 连接池最大连接数（建议：每核 CPU * 25，或根据并发需求调整）
HTTPX_MAX_CONNECTIONS=100
# HTTPX 连接池最大保持连接数（Keep-Alive）
HTTPX_MAX_KEEPALIVE_CONNECTIONS=20
# HTTPX 请求总超时时间（秒）
HTTPX_TIMEOUT=60.0
# HTTPX 连接超时时间（秒）
HTTPX_CONNECT_TIMEOUT=10.0
# Agent Cache
# 智能体配置缓存 TTL（秒），减少数据库查询压力
AGENT_CACHE_TTL=60
# 智能体缓存最大条目数
AGENT_CACHE_MAXSIZE=1000

# ==================== PythonLab Optimization（PythonLab 资源限制优化） ====================
# Container Resource Limits
# CPU 配额：100000 = 1 CPU 核。50000 = 0.5 CPU。用于限制每个沙箱容器的计算能力。
PYTHONLAB_DEFAULT_CPU_QUOTA=50000
# 内存限制（MB）：限制每个沙箱容器的最大内存使用量
PYTHONLAB_DEFAULT_MEMORY_MB=512
# 容器内最大进程数限制（防止 fork 炸弹）
PYTHONLAB_CONTAINER_PIDS_LIMIT=128
# 容器日志单文件最大大小（例如 "10m"）
PYTHONLAB_LOG_MAX_SIZE=10m
# 容器日志保留文件数量
PYTHONLAB_LOG_MAX_FILE=3

# ==================== Group Discussion Optimization（小组讨论优化） ====================
# 自动加入小组的时间窗口（小时）：只显示最近 N 小时内活跃或创建的小组
# 设置为 0 或负数则禁用过滤
GROUP_DISCUSSION_LIST_RECENT_HOURS=1
